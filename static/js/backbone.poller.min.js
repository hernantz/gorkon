/*
(c) 2012 Uzi Kilon, Splunk Inc.
Backbone Poller 0.2.4
https://github.com/uzikilon/backbone-poller
Backbone Poller may be freely distributed under the MIT license.
*/
(function(root,factory){"use strict";if(typeof define=="function"&&define.amd){define(["underscore","backbone"],factory)}else{root.Backbone.Poller=factory(root._,root.Backbone)}})(this,function(_,Backbone){"use strict";var defaults={delay:1e3,condition:function(){return true}};var events=["start","stop","fetch","success","error","complete"];var pollers=[];function findPoller(model){return _.find(pollers,function(poller){return poller.model===model})}var PollingManager={get:function(model,options){var poller=findPoller(model);if(!poller){poller=new Poller(model,options);pollers.push(poller)}else{poller.set(options)}if(options&&options.autostart===true){poller.start({silent:true})}return poller},size:function(){return pollers.length},reset:function(){while(pollers.length){pollers.pop().stop()}}};function Poller(model,options){this.model=model;this.set(options)}_.extend(Poller.prototype,Backbone.Events,{set:function(options){this.off();this.options=_.extend({},defaults,options||{});_.each(events,function(name){var callback=this.options[name];if(_.isFunction(callback)){this.on(name,callback,this)}},this);if(this.model instanceof Backbone.Model){this.model.on("destroy",this.stop,this)}return this.stop({silent:true})},start:function(options){if(!this.active()){options&&options.silent||this.trigger("start",this.model);this.options.active=true;run(this)}return this},stop:function(options){options&&options.silent||this.trigger("stop",this.model);this.options.active=false;this.xhr&&this.xhr.abort&&this.xhr.abort();this.xhr=null;clearTimeout(this.timeoutId);this.timeoutId=null;return this},active:function(){return this.options.active===true}});function run(poller){if(poller.options.delayed){delayedRun(poller);return}if(poller.active()!==true){poller.stop({silent:true});return}var options=_.extend({},poller.options,{success:function(){poller.trigger("success",poller.model);delayedRun(poller)},error:function(){poller.stop({silent:true});poller.trigger("error",poller.model)}});poller.trigger("fetch",poller.model);poller.xhr=poller.model.fetch(options)}function delayedRun(poller){if(poller.options.condition(poller.model)!==true){poller.stop({silent:true});poller.trigger("complete",poller.model);return}poller.options.delayed=false;poller.timeoutId=_.delay(run,poller.options.delay,poller)}return PollingManager});